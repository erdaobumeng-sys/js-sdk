const express = require("express");
const fetch = require("node-fetch");

const app = express();
app.use(express.json());

const ACCESS_TOKEN = process.env.ACCESS_TOKEN;

// ===== „Ç≤„Éº„É†Áä∂ÊÖãÔºà„É°„É¢„É™Ôºâ=====
const games = {};

// ===== Webhook =====
app.post("/webhook", async (req, res) => {
  const event = req.body.events?.[0];
    if (!event || event.type !== "message") {
        return res.send("OK");
          }

            const text = event.message.text;
              const userId = event.source.userId;
                const groupId = event.source.groupId;

                  if (!groupId) {
                      await reply(event.replyToken, "„Ç∞„É´„Éº„Éó„Åß‰Ωø„Å£„Å¶„Å≠");
                          return res.send("OK");
                            }

                              const game = games[groupId] ??= {
                                  phase: "idle",
                                      players: {},
                                          roles: {},
                                              votes: {}
                                                };

                                                  let replyText = "";

                                                    // ===== „Ç≥„Éû„É≥„Éâ =====
                                                      if (text === "/start") {
                                                          game.phase = "join";
                                                              game.players = {};
                                                                  replyText = "üê∫ „ÉØ„É≥„Éä„Ç§„Éà‰∫∫ÁãºÈñãÂßãÔºÅ\nÂèÇÂä†„Åô„Çã‰∫∫„ÅØ /join";
                                                                    }

                                                                      else if (text === "/join") {
                                                                          if (game.phase !== "join") {
                                                                                replyText = "‰ªä„ÅØÂèÇÂä†Âèó‰ªò‰∏≠„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                    } else {
                                                                                          game.players[userId] = true;
                                                                                                replyText = "‚úÖ ÂèÇÂä†„Åó„Åæ„Åó„Åü";
                                                                                                    }
                                                                                                      }

                                                                                                        else if (text === "/begin") {
                                                                                                            const ids = Object.keys(game.players);
                                                                                                                if (ids.length < 2) {
                                                                                                                      replyText = "‰∫∫Êï∞„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºà2‰∫∫‰ª•‰∏äÔºâ";
                                                                                                                          } else {
                                                                                                                                game.phase = "play";
                                                                                                                                      game.roles = {};
                                                                                                                                            game.votes = {};

                                                                                                                                                  const wolf = ids[Math.floor(Math.random() * ids.length)];
                                                                                                                                                        for (const id of ids) {
                                                                                                                                                                game.roles[id] = id === wolf ? "wolf" : "villager";
                                                                                                                                                                      }

                                                                                                                                                                            replyText = "üåô Â§ú„ÅåÊòé„Åë„Åæ„Åó„Åü„ÄÇÂΩπËÅ∑„ÅØÂÄãÂà•„Å´ÈÄöÁü•„Åó„Åæ„Åó„Åü";

                                                                                                                                                                                  for (const id of ids) {
                                                                                                                                                                                          await push(
                                                                                                                                                                                                    id,
                                                                                                                                                                                                              game.roles[id] === "wolf"
                                                                                                                                                                                                                          ? "üê∫ „ÅÇ„Å™„Åü„ÅØ„Äê‰∫∫Áãº„Äë„Åß„Åô"
                                                                                                                                                                                                                                      : "üôÇ „ÅÇ„Å™„Åü„ÅØ„ÄêÊùë‰∫∫„Äë„Åß„Åô"
                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                            else if (text.startsWith("/vote")) {
                                                                                                                                                                                                                                                                if (game.phase !== "play") {
                                                                                                                                                                                                                                                                      replyText = "‰ªä„ÅØÊäïÁ•®„Éï„Çß„Éº„Ç∫„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                const target = text.split(" ")[1];
                                                                                                                                                                                                                                                                                      game.votes[userId] = target;
                                                                                                                                                                                                                                                                                            replyText = "üó≥Ô∏è ÊäïÁ•®„Åó„Åæ„Åó„Åü";
                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                    else if (text === "/result") {
                                                                                                                                                                                                                                                                                                        const count = {};
                                                                                                                                                                                                                                                                                                            for (const v of Object.values(game.votes)) {
                                                                                                                                                                                                                                                                                                                  count[v] = (count[v] || 0) + 1;
                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                          const result = Object.entries(count)
                                                                                                                                                                                                                                                                                                                                .sort((a, b) => b[1] - a[1])[0];

                                                                                                                                                                                                                                                                                                                                    const wolfId = Object.keys(game.roles)
                                                                                                                                                                                                                                                                                                                                          .find(id => game.roles[id] === "wolf");

                                                                                                                                                                                                                                                                                                                                              replyText =
                                                                                                                                                                                                                                                                                                                                                    result && result[0] === wolfId
                                                                                                                                                                                                                                                                                                                                                            ? "üéâ Êùë‰∫∫„ÅÆÂãùÂà©ÔºÅ‰∫∫Áãº„ÅåÂá¶Âàë„Åï„Çå„ÅüÔºÅ"
                                                                                                                                                                                                                                                                                                                                                                    : "üíÄ ‰∫∫Áãº„ÅÆÂãùÂà©ÔºÅ";

                                                                                                                                                                                                                                                                                                                                                                        game.phase = "idle";
                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                            if (replyText) {
                                                                                                                                                                                                                                                                                                                                                                                await reply(event.replyToken, replyText);
                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                    res.send("OK");
                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                    // ===== LINE API =====
                                                                                                                                                                                                                                                                                                                                                                                    async function reply(replyToken, text) {
                                                                                                                                                                                                                                                                                                                                                                                      await fetch("https://api.line.me/v2/bot/message/reply", {
                                                                                                                                                                                                                                                                                                                                                                                          method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                              headers: {
                                                                                                                                                                                                                                                                                                                                                                                                    "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                          "Authorization": `Bearer ${ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                  body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                        replyToken,
                                                                                                                                                                                                                                                                                                                                                                                                                              messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                  })
                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                    async function push(userId, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                      await fetch("https://api.line.me/v2/bot/message/push", {
                                                                                                                                                                                                                                                                                                                                                                                                                                          method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                              headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                          "Authorization": `Bearer ${ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        to: userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ===== „Çµ„Éº„Éê„ÉºËµ∑Âãï =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const PORT = process.env.PORT || 3000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    app.listen(PORT, () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      console.log("Server running on port", PORT);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });