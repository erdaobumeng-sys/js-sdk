export default {
      async fetch(req, env) {
          if (req.method !== "POST") return new Response("OK");

              const body = await req.json();
                  const event = body.events?.[0];
                      if (!event || event.type !== "message") return new Response("OK");

                          const text = event.message.text;
                              const userId = event.source.userId;
                                  const groupId = event.source.groupId;

                                      // ===== „Ç≤„Éº„É†Áä∂ÊÖãÔºà„É°„É¢„É™Ôºâ=====
                                          globalThis.games ??= {};
                                              const game = globalThis.games[groupId] ??= {
                                                    phase: "idle",
                                                          players: {},
                                                                roles: {},
                                                                      votes: {}
                                                                          };

                                                                              let reply = "";

                                                                                  // ===== „Ç≥„Éû„É≥„Éâ =====
                                                                                      if (text === "/start") {
                                                                                            game.phase = "join";
                                                                                                  game.players = {};
                                                                                                        reply = "üê∫ „ÉØ„É≥„Éä„Ç§„Éà‰∫∫ÁãºÈñãÂßãÔºÅ\nÂèÇÂä†„Åô„Çã‰∫∫„ÅØ /join";
                                                                                                            }

                                                                                                                else if (text === "/join") {
                                                                                                                      if (game.phase !== "join") {
                                                                                                                              reply = "‰ªä„ÅØÂèÇÂä†Âèó‰ªò‰∏≠„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                                                                    } else {
                                                                                                                                            game.players[userId] = true;
                                                                                                                                                    reply = "‚úÖ ÂèÇÂä†„Åó„Åæ„Åó„Åü";
                                                                                                                                                          }
                                                                                                                                                              }

                                                                                                                                                                  else if (text === "/begin") {
                                                                                                                                                                        const ids = Object.keys(game.players);
                                                                                                                                                                              if (ids.length < 2) {
                                                                                                                                                                                      reply = "‰∫∫Êï∞„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºà2‰∫∫‰ª•‰∏äÔºâ";
                                                                                                                                                                                            } else {
                                                                                                                                                                                                    game.phase = "play";
                                                                                                                                                                                                            game.roles = {};
                                                                                                                                                                                                                    game.votes = {};

                                                                                                                                                                                                                            const wolf = ids[Math.floor(Math.random() * ids.length)];
                                                                                                                                                                                                                                    for (const id of ids) {
                                                                                                                                                                                                                                              game.roles[id] = id === wolf ? "wolf" : "villager";
                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                              reply = "üåô Â§ú„ÅåÊòé„Åë„Åæ„Åó„Åü„ÄÇÂΩπËÅ∑„ÅØÂÄãÂà•„Å´ÈÄöÁü•„Åó„Åæ„Åó„Åü";

                                                                                                                                                                                                                                                                      await Promise.all(
                                                                                                                                                                                                                                                                                ids.map(id =>
                                                                                                                                                                                                                                                                                            pushMessage(
                                                                                                                                                                                                                                                                                                          env,
                                                                                                                                                                                                                                                                                                                        id,
                                                                                                                                                                                                                                                                                                                                      game.roles[id] === "wolf"
                                                                                                                                                                                                                                                                                                                                                      ? "üê∫ „ÅÇ„Å™„Åü„ÅØ„Äê‰∫∫Áãº„Äë„Åß„Åô"
                                                                                                                                                                                                                                                                                                                                                                      : "üôÇ „ÅÇ„Å™„Åü„ÅØ„ÄêÊùë‰∫∫„Äë„Åß„Åô"
                                                                                                                                                                                                                                                                                                                                                                                  )
                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                  else if (text.startsWith("/vote")) {
                                                                                                                                                                                                                                                                                                                                                                                                                        if (game.phase !== "play") {
                                                                                                                                                                                                                                                                                                                                                                                                                                reply = "‰ªä„ÅØÊäïÁ•®„Éï„Çß„Éº„Ç∫„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                                                                                                                                                                                                                                                                                                                                                                      } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                              const target = text.split(" ")[1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                      game.votes[userId] = target;
                                                                                                                                                                                                                                                                                                                                                                                                                                                              reply = "üó≥Ô∏è ÊäïÁ•®„Åó„Åæ„Åó„Åü";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else if (text === "/result") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const count = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (const v of Object.values(game.votes)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                count[v] = (count[v] || 0) + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const result = Object.entries(count)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .sort((a, b) => b[1] - a[1])[0];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const wolfId = Object.keys(game.roles)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .find(id => game.roles[id] === "wolf");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        reply =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                result && result[0] === wolfId
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ? "üéâ Êùë‰∫∫„ÅÆÂãùÂà©ÔºÅ‰∫∫Áãº„ÅåÂá¶Âàë„Åï„Çå„ÅüÔºÅ"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    : "üíÄ ‰∫∫Áãº„ÅÆÂãùÂà©ÔºÅ";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          game.phase = "idle";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (reply) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await replyMessage(env, event.replyToken, reply);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return new Response("OK");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // ===== LINE API =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function replyMessage(env, token, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await fetch("https://api.line.me/v2/bot/message/reply", {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Authorization": `Bearer ${env.ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      replyToken: token,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function pushMessage(env, userId, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await fetch("https://api.line.me/v2/bot/message/push", {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Authorization": `Bearer ${env.ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      to: userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  