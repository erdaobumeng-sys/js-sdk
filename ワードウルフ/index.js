const express = require("express");
const fetch = require("node-fetch");

const app = express();
app.use(express.json());

const ACCESS_TOKEN = process.env.ACCESS_TOKEN;

// ===== „Ç≤„Éº„É†Áä∂ÊÖã =====
const games = {};

// ===== Webhook =====
app.post("/webhook", async (req, res) => {
  const event = req.body.events?.[0];
    if (!event || event.type !== "message") {
        return res.send("OK");
          }

            const text = event.message.text.trim();
              const userId = event.source.userId;
                const groupId = event.source.groupId;

                  if (!groupId) {
                      await reply(event.replyToken, "„Ç∞„É´„Éº„Éó„Åß‰Ωø„Å£„Å¶„Å≠");
                          return res.send("OK");
                            }

                              const game = games[groupId] ??= {
                                  phase: "idle",
                                      players: {},
                                          liar: null,
                                              themes: {}
                                                };

                                                  let replyText = "";

                                                    // ===== „Ç≥„Éû„É≥„Éâ =====

                                                      // „Ç≤„Éº„É†ÈñãÂßã
                                                        if (text === "/liar") {
                                                            game.phase = "join";
                                                                game.players = {};
                                                                    game.liar = null;
                                                                        game.themes = {};

                                                                            replyText =
                                                                                  "üé≠ Âòò„Å§„Åç„ÅØË™∞„Å† ÈñãÂßãÔºÅ\n" +
                                                                                        "ÂèÇÂä†„Åô„Çã‰∫∫„ÅØ /join";
                                                                                          }

                                                                                            // ÂèÇÂä†
                                                                                              else if (text === "/join") {
                                                                                                  if (game.phase !== "join") {
                                                                                                        replyText = "‰ªä„ÅØÂèÇÂä†Âèó‰ªò‰∏≠„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                                            } else {
                                                                                                                  game.players[userId] = true;
                                                                                                                        replyText = "‚úÖ ÂèÇÂä†„Åó„Åæ„Åó„Åü";
                                                                                                                            }
                                                                                                                              }

                                                                                                                                // ÂèÇÂä†ËÄÖ‰∏ÄË¶ß
                                                                                                                                  else if (text === "/players") {
                                                                                                                                      const count = Object.keys(game.players).length;
                                                                                                                                          replyText = `üë• ÁèæÂú®„ÅÆÂèÇÂä†ËÄÖÔºö${count}‰∫∫`;
                                                                                                                                            }

                                                                                                                                              // ÈñãÂßãÔºà„ÅäÈ°åÈÖçÂ∏ÉÔºâ
                                                                                                                                                else if (text === "/begin") {
                                                                                                                                                    const ids = Object.keys(game.players);
                                                                                                                                                        if (ids.length < 3) {
                                                                                                                                                              replyText = "‰∫∫Êï∞„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºà3‰∫∫‰ª•‰∏äÔºâ";
                                                                                                                                                                  } else {
                                                                                                                                                                        game.phase = "play";

                                                                                                                                                                              // Âòò„Å§„ÅçÊ±∫ÂÆö
                                                                                                                                                                                    game.liar = ids[Math.floor(Math.random() * ids.length)];

                                                                                                                                                                                          for (const id of ids) {
                                                                                                                                                                                                  if (id === game.liar) {
                                                                                                                                                                                                            game.themes[id] = "Â´å„ÅÑ„Å™È£ü„ÅπÁâ©";
                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                              game.themes[id] = "Â•Ω„Åç„Å™È£ü„ÅπÁâ©";
                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                              await push(
                                                                                                                                                                                                                                                        id,
                                                                                                                                                                                                                                                                  `üß† „ÅäÈ°åÔºö${game.themes[id]}\n1Êñá„ÅßÁ≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ`
                                                                                                                                                                                                                                                                          );
                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                      replyText =
                                                                                                                                                                                                                                                                                              "üó£Ô∏è „ÅäÈ°å„ÇíÂÄãÂà•„Å´ÈÄÅ„Çä„Åæ„Åó„Åü\n" +
                                                                                                                                                                                                                                                                                                      "ÂÖ®Âì°1Êñá„ÅßÁô∫Ë®Ä„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                              // ÊäïÁ•®
                                                                                                                                                                                                                                                                                                                else if (text.startsWith("/vote")) {
                                                                                                                                                                                                                                                                                                                    if (game.phase !== "play") {
                                                                                                                                                                                                                                                                                                                          replyText = "‰ªä„ÅØÊäïÁ•®„Éï„Çß„Éº„Ç∫„Åò„ÇÉ„Å™„ÅÑ„Çà";
                                                                                                                                                                                                                                                                                                                              } else {
                                                                                                                                                                                                                                                                                                                                    replyText = "üó≥Ô∏è ÊäïÁ•®„Åó„Åæ„Åó„Åü\n/result „ÅßÁµêÊûúÁô∫Ë°®";
                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                            // ÁµêÊûú
                                                                                                                                                                                                                                                                                                                                              else if (text === "/result") {
                                                                                                                                                                                                                                                                                                                                                  if (!game.liar) {
                                                                                                                                                                                                                                                                                                                                                        replyText = "„Åæ„Å†„Ç≤„Éº„É†„ÅåÂßã„Åæ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì";
                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                  replyText =
                                                                                                                                                                                                                                                                                                                                                                          "üé≠ ÁµêÊûúÁô∫Ë°®ÔºÅ\n" +
                                                                                                                                                                                                                                                                                                                                                                                  "Âòò„Å§„Åç„ÅØ‚Ä¶‚Ä¶\n" +
                                                                                                                                                                                                                                                                                                                                                                                          "üòà „Åì„ÅÆ‰∏≠„Å´„ÅÑ„Åæ„ÅôÔºÅ\n\n" +
                                                                                                                                                                                                                                                                                                                                                                                                  "ÔºàÊ≠£Ëß£„ÅØË≠∞Ë´ñ„ÅßÊ±∫„ÇÅ„Å¶„Å≠Ôºâ";

                                                                                                                                                                                                                                                                                                                                                                                                        game.phase = "idle";
                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                // Âº∑Âà∂ÁµÇ‰∫Ü
                                                                                                                                                                                                                                                                                                                                                                                                                  else if (text === "/cancel") {
                                                                                                                                                                                                                                                                                                                                                                                                                      delete games[groupId];
                                                                                                                                                                                                                                                                                                                                                                                                                          replyText = "‚ùå „Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü";
                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                              // ===== Ëøî‰ø° =====
                                                                                                                                                                                                                                                                                                                                                                                                                                if (replyText) {
                                                                                                                                                                                                                                                                                                                                                                                                                                    await reply(event.replyToken, replyText);
                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                        res.send("OK");
                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                        // ===== LINE API =====
                                                                                                                                                                                                                                                                                                                                                                                                                                        async function reply(replyToken, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                          await fetch("https://api.line.me/v2/bot/message/reply", {
                                                                                                                                                                                                                                                                                                                                                                                                                                              method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                  headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                              "Authorization": `Bearer ${ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            replyToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async function push(userId, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await fetch("https://api.line.me/v2/bot/message/push", {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "Authorization": `Bearer ${ACCESS_TOKEN}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      body: JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            to: userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  messages: [{ type: "text", text }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ===== „Çµ„Éº„Éê„ÉºËµ∑Âãï =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const PORT = process.env.PORT || 3000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app.listen(PORT, () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.log("Server running on port", PORT);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });