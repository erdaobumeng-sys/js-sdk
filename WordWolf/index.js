const express = require("express");
const fetch = require("node-fetch");

const app = express();
app.use(express.json());

const ACCESS_TOKEN = process.env.ACCESS_TOKEN;

// ===== „Ç≤„Éº„É†Áä∂ÊÖã =====
let game = {
  active: false,
    groupId: null,
      players: [],      // userId[]
        liar: null,       // userId
          votes: {},        // voterId -> targetId
          };

          // ===== LINEÈÄÅ‰ø° =====
          async function reply(replyToken, text) {
            return fetch("https://api.line.me/v2/bot/message/reply", {
                method: "POST",
                    headers: {
                          "Content-Type": "application/json",
                                Authorization: `Bearer ${ACCESS_TOKEN}`,
                                    },
                                        body: JSON.stringify({
                                              replyToken,
                                                    messages: [{ type: "text", text }],
                                                        }),
                                                          });
                                                          }

                                                          async function push(userId, text) {
                                                            return fetch("https://api.line.me/v2/bot/message/push", {
                                                                method: "POST",
                                                                    headers: {
                                                                          "Content-Type": "application/json",
                                                                                Authorization: `Bearer ${ACCESS_TOKEN}`,
                                                                                    },
                                                                                        body: JSON.stringify({
                                                                                              to: userId,
                                                                                                    messages: [{ type: "text", text }],
                                                                                                        }),
                                                                                                          });
                                                                                                          }

                                                                                                          // ===== Webhook =====
                                                                                                          app.post("/webhook", async (req, res) => {
                                                                                                            const events = req.body.events || [];

                                                                                                              for (const e of events) {
                                                                                                                  if (e.type !== "message") continue;
                                                                                                                      if (e.message.type !== "text") continue;

                                                                                                                          const text = e.message.text.trim();
                                                                                                                              const replyToken = e.replyToken;
                                                                                                                                  const userId = e.source.userId;
                                                                                                                                      const groupId = e.source.groupId;

                                                                                                                                          // ===== ÂãüÈõÜ =====
                                                                                                                                              if (text === "/liar start") {
                                                                                                                                                    game = {
                                                                                                                                                            active: true,
                                                                                                                                                                    groupId,
                                                                                                                                                                            players: [],
                                                                                                                                                                                    liar: null,
                                                                                                                                                                                            votes: {},
                                                                                                                                                                                                  };
                                                                                                                                                                                                        await reply(replyToken, "üé≠ Âòò„Å§„Åç„ÅØË™∞„Å† ÂãüÈõÜÈñãÂßãÔºÅ\nÂèÇÂä†„ÅØ /join");
                                                                                                                                                                                                            }

                                                                                                                                                                                                                // ===== ÂèÇÂä† =====
                                                                                                                                                                                                                    else if (text === "/join" && game.active && game.groupId === groupId) {
                                                                                                                                                                                                                          if (!game.players.includes(userId)) {
                                                                                                                                                                                                                                  game.players.push(userId);
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                              await reply(replyToken, "‚úÖ ÂèÇÂä†„Åó„Åæ„Åó„Åü");
                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                      // ===== „Ç≤„Éº„É†ÈñãÂßã =====
                                                                                                                                                                                                                                                          else if (text === "/liar begin" && game.active) {
                                                                                                                                                                                                                                                                if (game.players.length < 3) {
                                                                                                                                                                                                                                                                        await reply(replyToken, "‚ö†Ô∏è 3‰∫∫‰ª•‰∏äÂøÖË¶Å„Åß„Åô");
                                                                                                                                                                                                                                                                                continue;
                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                            game.liar =
                                                                                                                                                                                                                                                                                                    game.players[Math.floor(Math.random() * game.players.length)];

                                                                                                                                                                                                                                                                                                          for (const id of game.players) {
                                                                                                                                                                                                                                                                                                                  if (id === game.liar) {
                                                                                                                                                                                                                                                                                                                            await push(
                                                                                                                                                                                                                                                                                                                                        id,
                                                                                                                                                                                                                                                                                                                                                    "ü§• „ÅÇ„Å™„Åü„ÅØ„ÄêÂòò„Å§„Åç„Äë„Åß„Åô„ÄÇ\n‰ºöË©±„Åß„Éê„É¨„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                      } else {
                                                                                                                                                                                                                                                                                                                                                                                await push(
                                                                                                                                                                                                                                                                                                                                                                                            id,
                                                                                                                                                                                                                                                                                                                                                                                                        "üó£ „ÅäÈ°åÔºö„ÄêÂ•Ω„Åç„Å™È£ü„ÅπÁâ©„Äë\nÊ≠£Áõ¥„Å´Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ"
                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                      await reply(
                                                                                                                                                                                                                                                                                                                                                                                                                                              replyToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                      "üí¨ ‰ºöË©±„Çπ„Çø„Éº„ÉàÔºÅ\nË©±„ÅóÂêà„Å£„Å¶Âòò„Å§„Åç„ÇíË¶ã„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ\nÊäïÁ•®„ÅØ /vote userId"
                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ===== ÊäïÁ•® =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else if (text.startsWith("/vote ") && game.active) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const target = text.split(" ")[1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    game.votes[userId] = target;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await reply(replyToken, "üó≥ ÊäïÁ•®„Åó„Åæ„Åó„Åü");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // ===== ÁµêÊûú =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      else if (text === "/liar end" && game.active) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const result = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  for (const v of Object.values(game.votes)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          result[v] = (result[v] || 0) + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let max = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let selected = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  for (const id in result) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (result[id] > max) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    max = result[id];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              selected = id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const win =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          selected === game.liar
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ? "üéâ Ê≠£Ëß£ÔºÅÂòò„Å§„Åç„ÇíÂΩì„Å¶„Åæ„Åó„ÅüÔºÅ"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              : "üíÄ „Éè„Ç∫„É¨ÔºÅÂòò„Å§„Åç„ÅÆÂãù„Å°ÔºÅ";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await reply(replyToken, win);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          game.active = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  res.sendStatus(200);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // ===== Ëµ∑Âãï =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const PORT = process.env.PORT || 3000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  app.listen(PORT, () => console.log("Âòò„Å§„Åç„ÅØË™∞„Å†BOT Ëµ∑Âãï"));