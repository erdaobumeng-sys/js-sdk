"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.aggregate = void 0;
const depsUtils_1 = require("./depsUtils");
const getDependencies_1 = require("./getDependencies");
const getLicenseText_1 = require("./getLicenseText");
const aggregate = async (packageManager, query, cwd, workspace, unreadLicenseTextPattern, config) => {
    let deps;
    if (packageManager === "pnpm") {
        if (![":root *", ":root .prod"].includes(query))
            throw new Error("query cannot be specified when the package manager is pnpm.");
        const option = query.includes(".prod") ? "-P" : "";
        deps = await (0, getDependencies_1.getDependenciesForPnpm)(option, cwd, workspace);
    }
    else {
        deps = await (0, getDependencies_1.getDependenciesForNpm)(query, cwd, workspace);
    }
    return Promise.all(deps.map(async (dep) => {
        const license = (0, depsUtils_1.getLicense)(dep, config.overrideLicense);
        const unreadLicenseText = unreadLicenseTextPattern.some((pattern) => (0, depsUtils_1.isMatchPackage)(dep, pattern));
        const licenseTextData = unreadLicenseText ? null : await (0, getLicenseText_1.getLicenseText)(dep, config.overrideLicenseText);
        const apacheNotice = !unreadLicenseText && license === "Apache-2.0" ? (0, getLicenseText_1.getApacheNotice)(dep) : null;
        return {
            ...dep,
            license,
            ...(licenseTextData || {}),
            ...(apacheNotice || {}),
        };
    }));
};
exports.aggregate = aggregate;
